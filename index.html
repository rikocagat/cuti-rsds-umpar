<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pengajuan Cuti RSUD dr. Soedarso</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Signature Pad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<style>
:root{
  --bg:#f7fafc;--panel:#fff;--text:#0f172a;--muted:#64748b;
  --pri:#06b6d4;--ok:#22c55e;--border:#e2e8f0;--r:16px
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#fff,#f7fafc);
  padding:16px;color:var(--text)
}
.container{
  max-width:900px;margin:auto;background:#fff;border:1px solid var(--border);
  border-radius:20px;box-shadow:0 20px 40px rgba(2,6,23,.08)
}
header{padding:20px;border-bottom:1px solid var(--border)}
h1{margin:0;font-size:22px}
.subtitle{font-size:14px;color:var(--muted)}

.stepper{display:flex;gap:8px;padding:12px;overflow-x:auto}
.step{
  padding:8px 14px;border-radius:999px;border:1px solid var(--border);
  font-size:14px;color:var(--muted);background:#fff
}
.step.active{background:#ecfeff;border-color:#7dd3fc;color:#000}
.step.done{background:#f0fdf4;border-color:#86efac;color:#166534}

.panel{display:none;padding:16px}
.panel.active{display:block}

label{font-weight:600;font-size:14px}
input,select,textarea{
  width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
  margin-top:6px
}
input:focus,select:focus,textarea:focus{
  outline:none;border-color:#7dd3fc
}

.ac-wrap{
  position:absolute;left:0;right:0;top:100%;background:#fff;
  border:1px solid var(--border);border-radius:12px;
  max-height:240px;overflow:auto;z-index:20;display:none
}
.ac-item{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between}
.ac-item:hover{background:#f0f9ff}

.btn{
  padding:12px 16px;border-radius:12px;border:1px solid var(--border);
  background:#fff;cursor:pointer
}
.btn-primary{background:#e0f2fe;border-color:#7dd3fc}
.btn-success{background:#dcfce7;border-color:#86efac}
.footer{display:flex;justify-content:space-between;padding:14px;border-top:1px solid var(--border)}

.file-item{
  padding:10px;border:1px solid var(--border);
  border-radius:10px;margin-top:8px;
  display:flex;justify-content:space-between
}

#signaturePad{
  width:100%;height:220px;border:1px solid var(--border);
  border-radius:12px;background:#fff
}
.success{padding:30px;text-align:center;display:none}
</style>
</head>

<body>
<div class="container">
<header>
  <h1>Pengajuan Cuti</h1>
  <div class="subtitle">RSUD dr. Soedarso</div>
</header>

<div class="stepper">
  <div class="step active" id="s1">1 Data</div>
  <div class="step" id="s2">2 Berkas</div>
  <div class="step" id="s3">3 TTD</div>
</div>

<form id="form">

<!-- STEP 1 -->
<section class="panel active" id="step1">
  <div style="position:relative">
    <label>Nama</label>
    <input id="nama" autocomplete="off" required>
    <div id="acBox" class="ac-wrap"></div>
  </div>

  <label>NIP</label>
  <input id="nip" readonly required>

  <label>No HP</label>
  <input id="hp" required>

  <label>Jenis Cuti</label>
  <select id="jenis" required>
    <option value="">Pilih</option>
    <option>TAHUNAN</option>
    <option>SAKIT</option>
    <option>MELAHIRKAN</option>
    <option>BESAR</option>
    <option>ALASAN_PENTING</option>
    <option>LUAR_NEGARA</option>
  </select>

  <label>Tanggal Mulai</label>
  <input type="date" id="tgl" required>

  <label>Lama (hari)</label>
  <input type="number" id="lama" required>

  <label>Alamat</label>
  <textarea id="alamat" required></textarea>
</section>

<!-- STEP 2 -->
<section class="panel" id="step2">
  <label>Upload 2 File PDF</label>
  <input type="file" id="pdf" accept="application/pdf" multiple>
  <div id="fileList"></div>
</section>

<!-- STEP 3 -->
<section class="panel" id="step3">
  <label>Tanda Tangan</label>
  <canvas id="signaturePad"></canvas>
  <button type="button" class="btn" onclick="pad.clear()">Hapus</button>
</section>

<div class="footer">
  <button type="button" class="btn" onclick="prev()">Kembali</button>
  <button type="button" class="btn btn-primary" id="nextBtn" onclick="next()">Next</button>
  <button type="button" class="btn btn-success" id="submitBtn" style="display:none" onclick="submitForm()">Kirim</button>
</div>
</form>

<div class="success" id="success">
  <h2>Berhasil</h2>
  <p>Pengajuan cuti telah dikirim.</p>
</div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = 'https://ufiqibxdgwlysqhinqbz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL';

/* ===== INIT ===== */
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let step=1,pad,files=[];

/* ===== STEP ===== */
function render(){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('step'+step).classList.add('active');
  ['s1','s2','s3'].forEach((id,i)=>{
    document.getElementById(id).classList.toggle('active',i+1===step);
    document.getElementById(id).classList.toggle('done',i+1<step);
  });
  nextBtn.style.display=step<3?'inline-block':'none';
  submitBtn.style.display=step===3?'inline-block':'none';
}
function next(){ if(step<3){step++;render()} }
function prev(){ if(step>1){step--;render()} }

/* ===== AUTOCOMPLETE ===== */
const nama=document.getElementById('nama');
const nip=document.getElementById('nip');
const ac=document.getElementById('acBox');
let t;
nama.addEventListener('input',()=>{
  clearTimeout(t);nip.value='';
  const q=nama.value.trim();
  if(q.length<2){ac.style.display='none';return;}
  t=setTimeout(async()=>{
    const {data}=await sb.from('pegawai')
      .select('nama,nip_nik').ilike('nama',q+'%').limit(10);
    if(!data?.length){ac.innerHTML='<div style="padding:10px">Tidak ada</div>';ac.style.display='block';return;}
    ac.innerHTML='';
    data.forEach(r=>{
      const d=document.createElement('div');
      d.className='ac-item';
      d.innerHTML=`<span>${r.nama}</span><span>${r.nip_nik}</span>`;
      d.onclick=()=>{nama.value=r.nama;nip.value=r.nip_nik;ac.style.display='none'};
      ac.appendChild(d);
    });
    ac.style.display='block';
  },300);
});

/* ===== FILE ===== */
pdf.onchange=()=>{
  files=[...pdf.files];
  if(files.length!==2){alert('Wajib 2 PDF');pdf.value='';files=[]}
  fileList.innerHTML='';
  files.forEach(f=>{
    const d=document.createElement('div');
    d.className='file-item';
    d.textContent=f.name;
    fileList.appendChild(d);
  });
};

/* ===== SIGN ===== */
pad=new SignaturePad(document.getElementById('signaturePad'),{backgroundColor:'#fff'});

/* ===== SUBMIT ===== */
async function submitForm(){
  if(pad.isEmpty()) return alert('TTD wajib');
  const sig=pad.toDataURL('image/png');
  const sigBlob=await(await fetch(sig)).blob();

  const sigPath=(await sb.storage.from('cuti-signature')
    .upload('ttd_'+Date.now()+'.png',sigBlob,{upsert:true})).data.path;

  const pdfPaths=[];
  for(const f of files){
    const r=await sb.storage.from('cuti-pdf')
      .upload(Date.now()+'_'+f.name,f,{upsert:true});
    pdfPaths.push(r.data.path);
  }

  await sb.from('pengajuan_cuti').insert({
    nama:nama.value,
    nip:nip.value,
    no_hp:hp.value,
    jenis_cuti:jenis.value,
    tgl_mulai:tgl.value,
    lama_cuti:lama.value,
    alamat:alamat.value,
    file_1_url:pdfPaths[0],
    file_2_url:pdfPaths[1],
    signature_url:sigPath
  });

  form.style.display='none';
  success.style.display='block';
}
render();
</script>
</body>
</html>
