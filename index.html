<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pengajuan Cuti RSDS</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<style>
body{background:radial-gradient(circle at top,#e0f2fe,#f8fafc)}
.card{background:#fff;border-radius:28px;box-shadow:0 30px 60px rgba(15,23,42,.15)}
.input{width:100%;padding:14px 16px;border-radius:16px;border:1px solid #cbd5e1}
.ac{position:absolute;z-index:50;background:#fff;border-radius:18px;border:1px solid #e2e8f0;max-height:260px;overflow:auto;width:100%}
.ac-item{padding:14px 18px;display:flex;justify-content:space-between;cursor:pointer}
.ac-item:hover{background:#e0f2fe}
.req-card{background:#e0f2fe;border-radius:18px;padding:16px}
</style>
</head>

<body class="min-h-screen flex justify-center p-6">
<main class="card w-full max-w-2xl p-8">

<h1 class="text-3xl font-bold text-sky-700">Pengajuan Cuti</h1>
<p class="text-sm text-slate-500 mb-8">RSUD dr. Soedarso</p>

<section class="space-y-4">

<div>
  <label>Nama Pegawai</label>
  <div class="relative">
    <input id="nama" class="input" autocomplete="off">
    <div id="acBox" class="ac hidden"></div>
  </div>
</div>

<div>
  <label>NIP</label>
  <input id="nip" class="input bg-slate-100" readonly>
</div>

<div>
  <label>No HP</label>
  <input id="hp" class="input">
</div>

<div>
  <label>Jenis Cuti</label>
  <select id="jenis" class="input">
    <option value="">Pilih</option>
    <option value="TAHUNAN">Tahunan</option>
    <option value="SAKIT">Sakit</option>
    <option value="MELAHIRKAN">Melahirkan</option>
    <option value="BESAR">Besar</option>
    <option value="ALASAN_PENTING">Alasan Penting</option>
    <option value="LUAR_NEGARA">Luar Negeri</option>
  </select>
</div>

<div class="grid grid-cols-2 gap-4">
  <input id="tgl" type="date" class="input">
  <input id="lama" type="number" class="input" placeholder="Lama hari">
</div>

<textarea id="alamat" class="input h-24" placeholder="Alamat selama cuti"></textarea>

<div id="reqBox" class="hidden req-card"></div>

<input id="pdf1" type="file" accept="application/pdf">
<input id="pdf2" type="file" accept="application/pdf">

<button id="btnTTD" class="w-full py-4 bg-sky-600 text-white rounded-xl">Lanjut TTD</button>

</section>

<section id="ttdSection" class="hidden mt-6">
  <canvas id="pad" class="w-full h-48 border rounded-xl bg-white"></canvas>
  <div class="flex justify-between mt-3">
    <button id="clear">Hapus</button>
    <button id="submit" class="bg-emerald-600 text-white px-6 py-3 rounded-xl">
      Kirim
    </button>
  </div>
</section>

<div id="done" class="hidden text-center mt-10 text-emerald-600 font-bold">
  BERHASIL TERKIRIM
</div>

</main>

<script>
/* ================= SUPABASE ================= */
const supabase = window.supabase.createClient(
  'https://ufiqibxdgwlysqhinqbz.supabase.co',
  'sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL'
);

/* ================= AUTOCOMPLETE ================= */
const nama=document.getElementById('nama');
const nip=document.getElementById('nip');
const acBox=document.getElementById('acBox');

nama.oninput=async()=>{
  const q=nama.value.trim();
  nip.value='';
  if(q.length<2){acBox.classList.add('hidden');return}

  const {data}=await supabase
    .from('pegawai')
    .select('nama,nip_nik')
    .ilike('nama',q+'%')
    .limit(8);

  acBox.innerHTML='';
  data?.forEach(r=>{
    const d=document.createElement('div');
    d.className='ac-item';
    d.innerHTML=`<span>${r.nama}</span><span>${r.nip_nik}</span>`;
    d.onclick=()=>{nama.value=r.nama;nip.value=r.nip_nik;acBox.classList.add('hidden')};
    acBox.appendChild(d);
  });
  acBox.classList.remove('hidden');
};

/* ================= TTD ================= */
let pad;
document.getElementById('btnTTD').onclick=()=>{
  document.getElementById('ttdSection').classList.remove('hidden');
  if(!pad) pad=new SignaturePad(document.getElementById('pad'));
};

document.getElementById('clear').onclick=()=>pad.clear();

/* ================= SUBMIT ================= */
document.getElementById('submit').onclick=async()=>{
try{
  if(pad.isEmpty()) return alert('TTD wajib');

  const uid=crypto.randomUUID();

  const pdf1=document.getElementById('pdf1').files[0];
  const pdf2=document.getElementById('pdf2').files[0];
  if(!pdf1||!pdf2) return alert('PDF wajib 2');

  const up1=await supabase.storage.from('cuti-pdf')
    .upload(`pdf/${uid}_1.pdf`,pdf1);
  if(up1.error) throw up1.error;

  const up2=await supabase.storage.from('cuti-pdf')
    .upload(`pdf/${uid}_2.pdf`,pdf2);
  if(up2.error) throw up2.error;

  const sigBlob=await (await fetch(pad.toDataURL())).blob();
  const upSig=await supabase.storage.from('cuti-signature')
    .upload(`ttd/${uid}.png`,sigBlob);
  if(upSig.error) throw upSig.error;

  const dataInsert=await supabase.from('pengajuan_cuti').insert({
    nama:nama.value,
    nip:nip.value,
    no_hp:hp.value,
    jenis_cuti:jenis.value,
    tgl_mulai:tgl.value,
    lama_cuti:lama.value,
    alamat:alamat.value,
    file_1_url:supabase.storage.from('cuti-pdf').getPublicUrl(up1.data.path).data.publicUrl,
    file_2_url:supabase.storage.from('cuti-pdf').getPublicUrl(up2.data.path).data.publicUrl,
    signature_url:supabase.storage.from('cuti-signature').getPublicUrl(upSig.data.path).data.publicUrl,
    status:'DIAJUKAN'
  });

  if(dataInsert.error) throw dataInsert.error;

  document.getElementById('done').classList.remove('hidden');

}catch(e){
  console.error(e);
  alert(e.message);
}}
</script>
</body>
</html>
