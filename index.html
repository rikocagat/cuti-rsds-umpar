<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pengajuan Cuti RSDS</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<style>
body{
  background:radial-gradient(circle at top,#e0f2fe,#f8fafc);
}
.card{
  background:#fff;
  border-radius:28px;
  box-shadow:0 30px 60px rgba(15,23,42,.15);
}
.input{
  width:100%;
  padding:14px 16px;
  border-radius:16px;
  border:1px solid #cbd5e1;
}
.input:focus{
  outline:none;
  border-color:#38bdf8;
  box-shadow:0 0 0 4px rgba(56,189,248,.25);
}
.ac{
  position:absolute;
  z-index:50;
  background:#fff;
  border-radius:18px;
  border:1px solid #e2e8f0;
  max-height:260px;
  overflow:auto;
  width:100%;
}
.ac-item{
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  cursor:pointer;
}
.ac-item:hover{background:#e0f2fe}
.req-card{
  background:linear-gradient(135deg,#f0f9ff,#e0f2fe);
  border:1px solid #bae6fd;
  border-radius:18px;
  padding:16px;
}
canvas{touch-action:none}
</style>
</head>

<body class="min-h-screen flex justify-center p-6">
<main class="card w-full max-w-2xl p-8">

<h1 class="text-3xl font-bold text-sky-700">Pengajuan Cuti</h1>
<p class="text-sm text-slate-500 mb-8">RSUD dr. Soedarso</p>

<section class="space-y-4">

<div>
  <label class="font-semibold text-sm">Nama Pegawai</label>
  <div class="relative">
    <input id="nama" class="input" autocomplete="off" placeholder="Ketik minimal 2 huruf">
    <div id="acBox" class="ac hidden"></div>
  </div>
</div>

<div>
  <label class="font-semibold text-sm">NIP</label>
  <input id="nip" class="input bg-slate-100" readonly>
</div>

<div>
  <label class="font-semibold text-sm">No HP</label>
  <input id="hp" class="input">
</div>

<div>
  <label class="font-semibold text-sm">Jenis Cuti</label>
  <select id="jenis" class="input">
    <option value="">-- Pilih Jenis Cuti --</option>
    <option value="TAHUNAN">Cuti Tahunan</option>
    <option value="SAKIT">Cuti Sakit</option>
    <option value="MELAHIRKAN">Cuti Melahirkan</option>
    <option value="BESAR">Cuti Besar</option>
    <option value="ALASAN_PENTING">Alasan Penting</option>
    <option value="LUAR_NEGARA">Luar Negeri</option>
  </select>
</div>

<div class="grid grid-cols-2 gap-4">
  <input id="tgl" type="date" class="input">
  <input id="lama" type="number" class="input" placeholder="Lama (hari)">
</div>

<textarea id="alamat" class="input h-24" placeholder="Alamat selama cuti"></textarea>

<div id="reqBox" class="hidden req-card"></div>

<div>
  <label class="font-semibold text-sm">Upload 2 File PDF</label>
  <input id="pdf1" type="file" accept="application/pdf" class="mt-2">
  <input id="pdf2" type="file" accept="application/pdf" class="mt-2">
</div>

<button onclick="showTTD()" class="mt-6 w-full py-4 bg-sky-600 text-white rounded-xl font-bold">
  Lanjut Tanda Tangan
</button>

</section>

<section id="ttdSection" class="hidden mt-8">
  <canvas id="pad" class="w-full h-48 bg-white border rounded-xl"></canvas>
  <div class="flex justify-between mt-3">
    <button onclick="clearPad()" class="text-red-500">Hapus</button>
    <button onclick="submitForm()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold">
      Kirim Pengajuan
    </button>
  </div>
</section>

<div id="done" class="hidden text-center mt-10">
  <h2 class="text-xl font-bold text-emerald-600">Berhasil</h2>
  <p>Pengajuan cuti terkirim</p>
</div>

</main>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  'https://ufiqibxdgwlysqhinqbz.supabase.co',
  'sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL'
);

const requirements = {
  TAHUNAN:['Berkas cuti terakhir','Formulir permohonan cuti'],
  SAKIT:['Surat keterangan dokter','Formulir permohonan cuti'],
  MELAHIRKAN:['Surat keterangan dokter','Formulir permohonan cuti'],
  BESAR:['Formulir cuti TTD Kabid/Kabag'],
  ALASAN_PENTING:['Bukti alasan penting','Formulir permohonan cuti'],
  LUAR_NEGARA:['Surat permohonan TTD PPK','Formulir permohonan cuti']
};

/* ================= AUTOCOMPLETE ================= */
const nama=document.getElementById('nama');
const nip=document.getElementById('nip');
const acBox=document.getElementById('acBox');
let timer;

nama.addEventListener('input',()=>{
  clearTimeout(timer);
  nip.value='';
  const q=nama.value.trim();
  if(q.length<2){acBox.classList.add('hidden');return}

  timer=setTimeout(async()=>{
    const {data,error}=await sb
      .from('pegawai')
      .select('nama,nip_nik')
      .ilike('nama',q+'%')
      .limit(10);

    acBox.innerHTML='';
    if(error||!data?.length){
      acBox.innerHTML='<div class="p-4 text-slate-400">Tidak ada data</div>';
    }else{
      data.forEach(r=>{
        const d=document.createElement('div');
        d.className='ac-item';
        d.innerHTML=`<span>${r.nama}</span><span>${r.nip_nik}</span>`;
        d.onclick=()=>{
          nama.value=r.nama;
          nip.value=r.nip_nik;
          acBox.classList.add('hidden');
        };
        acBox.appendChild(d);
      });
    }
    acBox.classList.remove('hidden');
  },300);
});

/* ================= SYARAT CUTI ================= */
const jenis=document.getElementById('jenis');
const reqBox=document.getElementById('reqBox');

jenis.addEventListener('change',()=>{
  const r=requirements[jenis.value];
  if(!r){reqBox.classList.add('hidden');return}
  reqBox.innerHTML='<b>Syarat Dokumen:</b><br>'+r.map(x=>'â€¢ '+x).join('<br>');
  reqBox.classList.remove('hidden');
});

/* ================= TTD ================= */
let pad;
function showTTD(){
  document.getElementById('ttdSection').classList.remove('hidden');
  if(!pad) pad=new SignaturePad(document.getElementById('pad'),{backgroundColor:'#fff'});
}
function clearPad(){pad.clear()}

/* ================= SUBMIT ================= */
async function submitForm(){
try{
  if(pad.isEmpty()) return alert('Tanda tangan wajib');

  const f1=document.getElementById('pdf1').files[0];
  const f2=document.getElementById('pdf2').files[0];
  if(!f1||!f2) return alert('Dua file PDF wajib');

  const uid=crypto.randomUUID();

  const up1=await sb.storage.from('cuti-pdf').upload(`pdf/${uid}_1.pdf`,f1);
  if(up1.error) throw up1.error;

  const up2=await sb.storage.from('cuti-pdf').upload(`pdf/${uid}_2.pdf`,f2);
  if(up2.error) throw up2.error;

  const sigBlob=await (await fetch(pad.toDataURL())).blob();
  const upSig=await sb.storage.from('cuti-signature').upload(`ttd/${uid}.png`,sigBlob);
  if(upSig.error) throw upSig.error;

  const ins=await sb.from('pengajuan_cuti').insert({
    nama:nama.value,
    nip:nip.value,
    no_hp:hp.value,
    jenis_cuti:jenis.value,
    tgl_mulai:tgl.value,
    lama_cuti:lama.value,
    alamat:alamat.value,
    file_1_url:sb.storage.from('cuti-pdf').getPublicUrl(up1.data.path).data.publicUrl,
    file_2_url:sb.storage.from('cuti-pdf').getPublicUrl(up2.data.path).data.publicUrl,
    signature_url:sb.storage.from('cuti-signature').getPublicUrl(upSig.data.path).data.publicUrl,
    status:'DIAJUKAN'
  });

  if(ins.error) throw ins.error;

  document.getElementById('done').classList.remove('hidden');

}catch(e){
  console.error(e);
  alert('ERROR: '+e.message);
}}
</script>
</body>
</html>
